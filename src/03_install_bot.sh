#!/bin/bash

# –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Telegram-–±–æ—Ç–∞ (Refactored)
# –¢–µ–ø–µ—Ä—å –æ–Ω –∫–æ–ø–∏—Ä—É–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è, –∞ –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –µ–≥–æ.

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —á–µ—Ä–µ–∑ sudo!${NC}"
  exit 1
fi

echo -e "${GREEN}=== –£–°–¢–ê–ù–û–í–ö–ê TELEGRAM –ë–û–¢–ê –î–õ–Ø 3X-UI ===${NC}"

# 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç–∏
# –ù–∞—Ö–æ–¥–∏–º –ø–∞–ø–∫—É, –≥–¥–µ –ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç (src), –∏ –ø–æ–¥–Ω–∏–º–∞–µ–º—Å—è –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ –∫ –ø–∞–ø–∫–µ bot
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
BOT_SOURCE_DIR="$SCRIPT_DIR/../bot"
WORK_DIR="/opt/tg-bot"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–∞–ø–∫–∞ —Å –∫–æ–¥–æ–º
if [ ! -d "$BOT_SOURCE_DIR" ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–∞–ø–∫–∞ —Å –∫–æ–¥–æ–º –±–æ—Ç–∞!${NC}"
    echo "–û–∂–∏–¥–∞–µ–º—ã–π –ø—É—Ç—å: $BOT_SOURCE_DIR"
    exit 1
fi

# 2. –ü–æ–∏—Å–∫ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö 3x-ui
CRED_FILE="/root/.3xui_credentials"
if [ -f "$CRED_FILE" ]; then
    source "$CRED_FILE"
    echo "‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç –ø–∞–Ω–µ–ª–∏ 3x-ui –Ω–∞–π–¥–µ–Ω—ã."
else
    echo -e "${RED}‚ùå –§–∞–π–ª $CRED_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω! –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞–Ω–µ–ª—å 3x-ui.${NC}"
    exit 1
fi

# 3. –ó–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞
echo ""
echo "–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ (–ø–æ–ª—É—á–∏—Ç—å —É @BotFather):"
if [ -t 0 ]; then
    read -p "Token: " BOT_TOKEN
else
    read -p "Token: " BOT_TOKEN < /dev/tty
fi

if [ -z "$BOT_TOKEN" ]; then
    echo -e "${RED}‚ùå –¢–æ–∫–µ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!${NC}"
    exit 1
fi

# 4. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo "üìÇ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤..."
mkdir -p "$WORK_DIR"

# –ö–û–ü–ò–†–£–ï–ú –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ /opt/tg-bot
cp -r "$BOT_SOURCE_DIR/"* "$WORK_DIR/"
cd "$WORK_DIR"

# --- –ì–ï–ù–ï–†–ê–¶–ò–Ø docker-compose.yml ---
# (–ü–æ–∫–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç—É—Ç, –≤—ã–Ω–µ—Å–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ)
cat > docker-compose.yml <<EOF
version: '3.8'
services:
  tg-bot:
    build: .
    container_name: tg-bot
    restart: always
    networks:
      - shared-network
    env_file:
      - .env
networks:
  shared-network:
    external: true
EOF

# --- –ì–ï–ù–ï–†–ê–¶–ò–Ø .env ---
# .env –≤—Å–µ–≥–¥–∞ —É–Ω–∏–∫–∞–ª–µ–Ω –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–æ—ç—Ç–æ–º—É –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –µ–≥–æ –Ω–∞ –º–µ—Å—Ç–µ
cat > .env <<EOF
BOT_TOKEN=$BOT_TOKEN
XUI_URL=http://3x-ui:2053
XUI_USER=$USER
XUI_PASS=$PASS
EOF

# 5. –ó–∞–ø—É—Å–∫ Docker
echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ —á–∏—Å—Ç–∏–º –∫—ç—à —Å–±–æ—Ä–∫–∏
docker-compose down 2>/dev/null
docker-compose up -d --build

echo ""
echo "=========================================="
echo "‚úÖ –ë–û–¢ –û–ë–ù–û–í–õ–ï–ù –ò –ó–ê–ü–£–©–ï–ù!"
echo "–õ–æ–≥–∏: docker logs -f tg-bot"
echo "=========================================="